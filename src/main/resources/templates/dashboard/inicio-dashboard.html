<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Grupo Antonio</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/inicio-dashboardEstilos.css}">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Mejora del efecto hover existente: Añadir un brillo suave */
.boton-perfil-rojo:hover {
    background-color: #b71c1c; /* Color más oscuro */
    transform: translateY(-2px); /* Eleva el botón ligeramente */
    
    /* Efecto de sombra roja sutil (el "Glow") */
    box-shadow: 0 8px 15px rgba(211, 47, 47, 0.5); 
    
    /* Añadir transición para que el cambio de sombra sea suave */
    transition: all 0.3s ease;
}
        /* ESTILOS ORIGINALES */
        .status-dot-green { height: 10px; width: 10px; background-color: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot-red { height: 10px; width: 10px; background-color: #e74c3c; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .btn-vender { background-color: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        .btn-vender:hover { background-color: #2980b9; }
        .btn-pendiente { background-color: #e67e22; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        .btn-pendiente:hover { background-color: #d35400; }
        .pagination-container { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee; margin-top: 10px; }
        .page-btn { padding: 8px 16px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; color: #333; text-decoration: none; transition: 0.2s; }
        .page-btn:hover { background: #e9ecef; }
        .page-btn.disabled { opacity: 0.5; pointer-events: none; }
        .charts-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin: 30px 0; }
        .chart-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-title { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateY(-20px); transition: 0.3s ease; }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-icon { font-size: 50px; color: #3498db; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 10px; color: #333; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px;}
        .btn-modal { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: 0.2s; }
        .btn-cancel { background: #f1f1f1; color: #555; }
        .btn-confirm { background: #2ecc71; color: white; }

        /* NUEVO: Overlay de carga para la tabla AJAX */
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index: 10; border-radius: 8px; }
    </style>
    
</head>
<body>
    
    <div class="modal-overlay" id="customModal">
        <div class="modal-content">
            <div class="modal-icon"><i class="fas fa-check-circle"></i></div>
            <h3 class="modal-title">Confirmar Acción</h3>
            <p id="modalMessage">¿Deseas cambiar el estado?</p>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-modal btn-confirm" id="btnConfirmarModal">Sí, Confirmar</button>
            </div>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
<div class="logo">
    <a href="/" style="text-decoration: none; color: inherit;"> 
        <span class="logo-grupo">GRUPO</span>
        <span class="logo-antonio">ANTONIO</span>
    </a>
</div>            <button class="toggle-sidebar" id="toggleSidebar"><i class="fas fa-bars"></i></button>
        </div>
       <nav class="sidebar-nav">

    <div th:if="${rolUsuario == 'ADMIN'}">
        <p class="menu-label">Administración</p>
        
        <a href="/usuario/dashboard" class="nav-item" 
           th:classappend="${activePage == 'dashboard'} ? 'active'">
           <i class="fas fa-chart-line"></i><span>Dashboard</span>
        </a>

        <a href="/usuario/panel_usuario" class="nav-item" 
           th:classappend="${activePage == 'usuarios'} ? 'active'">
           <i class="fas fa-users-cog"></i><span>Usuarios</span>
        </a>

        <a href="/usuario/panel_productos" class="nav-item" 
           th:classappend="${activePage == 'productos'} ? 'active'">
           <i class="fas fa-box"></i><span>Productos</span>
        </a>
    </div>

    <div th:if="${rolUsuario == 'ADMIN' or rolUsuario == 'VENDEDOR'}">
        <p class="menu-label" th:if="${rolUsuario == 'VENDEDOR'}">Área de Ventas</p>

        <a href="/usuario/pedidos" class="nav-item" 
           th:classappend="${activePage == 'pedidos'} ? 'active'">
           <i class="fas fa-shopping-cart"></i><span>Pedidos</span>
        </a>
    </div>

    <div th:if="${rolUsuario == 'ADMIN' or rolUsuario == 'USUARIO' or rolUsuario == 'USER'}">
        <p class="menu-label" th:if="${rolUsuario != 'ADMIN'}">Mi Cuenta</p>
        
        <a href="/usuario/seguimiento" class="nav-item" 
           th:classappend="${activePage == 'seguimiento'} ? 'active'">
           <i class="fas fa-truck"></i><span>Mis Pedidos</span>
        </a>

        <a href="/" class="nav-item" th:if="${rolUsuario != 'ADMIN'}">
            <i class="fas fa-store"></i><span>Ir a Tienda</span>
        </a>
    </div>

    <div class="nav-spacer"></div>
    
    <a href="/usuario/logout" class="nav-item">
        <i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span>
    </a>

</nav>
        <div class="sidebar-footer">
            <div class="sidebar-user-box">
                <h4 class="sidebar-user-name" th:text="${nombreUsuario}">Usuario</h4>
                <p class="sidebar-user-status"><span class="status-dot"></span> Online</p>
            </div>
        </div>
    </aside>
    
    <main class="main-content">
        <div class="welcome-message">
            <div class="user-section">
                <h2>Bienvenido, <span th:text="${nombreUsuario}">Usuario</span></h2>
            </div>
            <div class="search-container">
                <input type="text" id="buscadorInput" placeholder="Filtrar página actual..." class="search-bar">
                <button class="search-button"><i class="fas fa-search"></i></button>
            </div>
        </div>
        
        <section class="stats-section">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                <div class="stat-info"><p class="stat-label">Total de pedidos</p><h3 class="stat-value" th:text="${totalPedidos}">0</h3></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-info"><p class="stat-label">Pedidos Pendientes</p><h3 class="stat-value" th:text="${pedidosPendientes}">0</h3></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-info"><p class="stat-label">Total de ganancias</p><h3 class="stat-value" th:text="'S/ ' + ${#numbers.formatDecimal(totalGanancias, 1, 2)}">S/ 0.00</h3></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-info"><p class="stat-label">Total de clientes</p><h3 class="stat-value" th:text="${totalClientes}">0</h3></div>
            </div>
            <button class="stat-card-actualizar" onclick="location.reload()">
                <div class="stat-icon"><i class="fas fa-sync-alt"></i></div>
                <div class="stat-info"><p class="stat-label">Actualizar</p><h3 class="stat-value">Ahora</h3></div>
            </button>
        </section>

        <section class="charts-section">
            <div class="chart-card">
                <h3 class="chart-title">Evolución de Ventas (S/)</h3>
                <div class="chart-container">
                    <canvas id="ventasChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Pedidos: Vendidos vs Pendientes</h3>
                <div class="chart-container">
                    <canvas id="estadosChart"></canvas>
                </div>
            </div>
        </section>
        
        <section class="orders-section">
            <h2 class="section-title">PEDIDOS RECIENTES</h2>
            <div class="card">
                <div class="card-body">
                    <div class="table-container" id="tablaContenedorAjax" style="position: relative;">
                        
                        <div class="loading-overlay" id="loadingOverlay">
                            <i class="fas fa-spinner fa-spin fa-2x" style="color: #3498db;"></i>
                        </div>

                        <table class="data-table" id="tablaPedidos">
                            <thead>
                                <tr><th>ID</th><th>Cliente</th><th>Fecha</th><th>Pago</th><th>Monto</th><th>Estado</th><th>Acción</th></tr>
                            </thead>
                            <tbody>
                                <tr th:each="pedido : ${listaPedidos}" th:id="'fila-' + ${pedido.id}">
                                    <td th:text="'#' + ${pedido.id}">#001</td>
                                    <td th:text="${pedido.usuario.id}">C-1234</td>
                                    <td th:text="${#temporals.format(pedido.fechaCreacion, 'dd/MM/yyyy')}">Date</td>
                                    <td th:text="${pedido.metodoPago != null ? pedido.metodoPago.tipoPago : '-'}">Card</td>
                                    <td th:text="'S/ ' + ${pedido.total}">S/ 0.00</td>
                                    <td>
                                        <span class="status-badge" th:id="'badge-' + ${pedido.id}">
                                            <span th:class="${pedido.estado == 'VENDIDO' ? 'status-dot-green' : 'status-dot-red'}"></span>
                                            <span th:text="${pedido.estado}">Pendiente</span>
                                        </span>
                                    </td>
                                    <td>
                                        <button th:id="'btn-' + ${pedido.id}"
                                                th:class="${pedido.estado == 'VENDIDO' ? 'btn-pendiente' : 'btn-vender'}"
                                                th:onclick="'prepararModal(' + ${pedido.id} + ', ' + ${pedido.total} + ')'"
                                                th:text="${pedido.estado == 'VENDIDO' ? '↺ Volver' : '✔ Vender'}">
                                            Acción
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(listaPedidos)}" id="filaVacia"><td colspan="7" style="text-align: center;">Sin pedidos.</td></tr>
                            </tbody>
                        </table>

                        <div class="pagination-container" th:if="${totalPaginas > 1}">
                            <a th:href="@{/usuario/dashboard(page=${paginaActual - 1})}" class="page-btn ajax-link" th:classappend="${paginaActual == 0} ? 'disabled'"><i class="fas fa-chevron-left"></i> Anterior</a>
                            <span class="page-info">Página <b th:text="${paginaActual + 1}">1</b> de <b th:text="${totalPaginas}">10</b></span>
                            <a th:href="@{/usuario/dashboard(page=${paginaActual + 1})}" class="page-btn ajax-link" th:classappend="${paginaActual + 1 >= totalPaginas} ? 'disabled'">Siguiente <i class="fas fa-chevron-right"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
   <script th:inline="javascript">
        // ==========================================
        // 1. UTILIDADES Y CONFIGURACIÓN
        // ==========================================
        const moneyFormatter = new Intl.NumberFormat('es-PE', {
            style: 'currency', currency: 'PEN', minimumFractionDigits: 2
        });

        const parseMoney = (str) => {
            if (!str) return 0;
            const limpio = str.replace(/[^\d.-]/g, ''); 
            return parseFloat(limpio) || 0;
        };

        function showToast(mensaje, tipo = 'success') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `<i class="fas ${tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${mensaje}`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        const toggleSidebar = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        if(toggleSidebar) toggleSidebar.addEventListener('click', () => sidebar.classList.toggle('collapsed'));


        // ==========================================
        // 2. GRÁFICOS (Chart.js)
        // ==========================================
        let chartVentas, chartEstados;

        document.addEventListener("DOMContentLoaded", function() {
            const labelsFechas = [[${graficoFechas}]] || ['Inicio'];
            const dataMontos = [[${graficoMontos}]] || [0];
            const vendidosIni = [[${pedidosVendidos}]] || 0;
            const pendientesIni = [[${pedidosPendientes}]] || 0;

            // A) Gráfico de Líneas (VENTAS)
            const ctxV = document.getElementById('ventasChart');
            if (ctxV) {
                let gradient = ctxV.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(52, 152, 219, 0.5)');
                gradient.addColorStop(1, 'rgba(52, 152, 219, 0.0)');

                chartVentas = new Chart(ctxV, {
                    type: 'line',
                    data: {
                        labels: labelsFechas,
                        datasets: [{
                            label: 'Ventas',
                            data: dataMontos,
                            borderColor: '#3498db', backgroundColor: gradient,
                            borderWidth: 3, tension: 0.4, fill: true,
                            pointBackgroundColor: '#fff', pointBorderColor: '#3498db', pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => moneyFormatter.format(c.parsed.y) } } },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                // ---> AQUÍ ESTÁ EL CAMBIO DE RANGO <---
                                max: 8000, 
                                grid: { borderDash: [5, 5] } 
                            }, 
                            x: { grid: { display: false } } 
                        }
                    }
                });
            }

            // B) Gráfico de Dona
            const ctxE = document.getElementById('estadosChart');
            if (ctxE) {
                chartEstados = new Chart(ctxE, {
                    type: 'doughnut',
                    data: {
                        labels: ['Vendidos', 'Pendientes'],
                        datasets: [{
                            data: [vendidosIni, pendientesIni],
                            backgroundColor: ['#2ecc71', '#e74c3c'], borderWidth: 0, hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom' } } }
                });
            }
        });


        // ==========================================
        // 3. BUSCADOR INTELIGENTE (ADAPTADO PARA AJAX)
        // ==========================================
        function inicializarBuscador() {
            const input = document.getElementById('buscadorInput');
            if (!input) return;

            // Limpiamos listeners previos para evitar duplicados si se llama varias veces
            const nuevoInput = input.cloneNode(true);
            input.parentNode.replaceChild(nuevoInput, input);

            nuevoInput.addEventListener('keyup', function() {
                const filtro = this.value.toLowerCase();
                const filas = document.querySelectorAll('#tablaPedidos tbody tr:not(#filaVacia):not(.no-results-row)');
                let visibles = 0;

                filas.forEach(fila => {
                    const texto = fila.textContent.toLowerCase();
                    const coincide = texto.includes(filtro);
                    fila.style.display = coincide ? '' : 'none';
                    if (coincide) visibles++;
                });

                let filaNoResultados = document.querySelector('.no-results-row');
                if (!filaNoResultados) {
                    const tbody = document.querySelector('#tablaPedidos tbody');
                    if(tbody) {
                        filaNoResultados = document.createElement('tr');
                        filaNoResultados.className = 'no-results-row';
                        filaNoResultados.innerHTML = `<td colspan="7" style="text-align:center; padding: 20px;">No se encontraron coincidencias</td>`;
                        tbody.appendChild(filaNoResultados);
                    }
                }
                
                if (filaNoResultados) {
                    filaNoResultados.style.display = (visibles === 0 && filtro !== '') ? 'table-row' : 'none';
                }
            });
        }
        // Llamada inicial
        inicializarBuscador();


        // ==========================================
        // 4. LÓGICA DE MODAL Y ACCIONES
        // ==========================================
        let pedidoActual = { id: 0, monto: 0 };
        const modal = document.getElementById('customModal');

        function prepararModal(id, monto) {
            const btn = document.getElementById(`btn-${id}`);
            if (!btn) return;
            const esVenta = btn.textContent.includes('Vender');
            pedidoActual = { id, monto };
            document.querySelector('.modal-title').textContent = esVenta ? "Confirmar Venta" : "Revertir Estado";
            document.getElementById('modalMessage').textContent = esVenta ? "El pedido pasará a VENDIDO..." : "El pedido volverá a PENDIENTE.";
            const btnConfirm = document.getElementById('btnConfirmarModal');
            btnConfirm.style.backgroundColor = esVenta ? "#2ecc71" : "#e67e22";
            btnConfirm.textContent = esVenta ? "Sí, Confirmar" : "Sí, Revertir";
            modal.classList.add('active');
        }

        function cerrarModal() { modal.classList.remove('active'); }

        document.getElementById('btnConfirmarModal').addEventListener('click', () => {
            ejecutarCambioEstado();
            cerrarModal();
        });

        async function ejecutarCambioEstado() {
            const { id, monto } = pedidoActual;
            const btn = document.getElementById(`btn-${id}`);
            const esVenta = btn.textContent.includes('Vender');
            const nuevoEstado = esVenta ? 'VENDIDO' : 'PENDIENTE';
            const textoOriginal = btn.textContent;
            
            btn.disabled = true; 
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`/usuario/pedido/cambiar-estado/${id}?estado=${nuevoEstado}`, { method: 'POST' });
                if (response.ok) {
                    actualizarInterfaz(id, monto, esVenta);
                    showToast(esVenta ? 'Vendido correctamente' : 'Revertido correctamente', 'success');
                } else throw new Error('Error');
            } catch (error) {
                showToast('Error de conexión', 'error');
                btn.disabled = false;
                btn.textContent = textoOriginal;
            }
        }

        function actualizarInterfaz(id, monto, esVenta) {
            const btn = document.getElementById(`btn-${id}`);
            const badge = document.getElementById(`badge-${id}`);
            if (esVenta) {
                btn.textContent = "↺ Volver";
                btn.className = "btn-pendiente";
                badge.innerHTML = '<span class="status-dot-green"></span> VENDIDO';
            } else {
                btn.textContent = "✔ Vender";
                btn.className = "btn-vender";
                badge.innerHTML = '<span class="status-dot-red"></span> PENDIENTE';
            }
            btn.disabled = false;
            
            if (chartEstados) {
                const cambio = esVenta ? 1 : -1;
                chartEstados.data.datasets[0].data[0] += cambio;
                chartEstados.data.datasets[0].data[1] -= cambio;
                chartEstados.update();
            }
            if (chartVentas) {
                const dataset = chartVentas.data.datasets[0].data;
                const lastIdx = dataset.length - 1;
                const actual = parseFloat(dataset[lastIdx]);
                let nuevo = esVenta ? (actual + parseFloat(monto)) : (actual - parseFloat(monto));
                if (nuevo < 0) nuevo = 0;
                dataset[lastIdx] = nuevo;
                chartVentas.update();
            }
        }

        // ==========================================
        // 5. NUEVA LÓGICA AJAX PARA PAGINACIÓN
        // ==========================================
        // Delegación de eventos para capturar clicks en los botones de paginación
        document.addEventListener('click', function(e) {
            // Verifica si se hizo clic en un botón de paginación o su icono
            const link = e.target.closest('.ajax-link');
            
            if (link && !link.classList.contains('disabled')) {
                e.preventDefault(); // Prevenir recarga completa
                const url = link.href;
                cargarPaginaTabla(url);
            }
        });

        async function cargarPaginaTabla(url) {
            const contenedor = document.getElementById('tablaContenedorAjax');
            const loading = document.getElementById('loadingOverlay');
            
            // Mostrar loading
            if(loading) loading.style.display = 'flex';
            contenedor.style.opacity = '0.6';

            try {
                const response = await fetch(url);
                const htmlTexto = await response.text();

                // Convertir el texto HTML en un documento virtual
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlTexto, 'text/html');

                // Extraer SOLO el nuevo contenedor de la tabla
                const nuevoContenido = doc.getElementById('tablaContenedorAjax').innerHTML;

                // Reemplazar el contenido actual
                contenedor.innerHTML = nuevoContenido;

                // Reactivar buscador para las nuevas filas
                inicializarBuscador();

            } catch (error) {
                console.error("Error cargando página:", error);
                showToast("Error al cambiar de página", "error");
            } finally {
                // Ocultar loading
                if(loading) loading.style.display = 'none';
                contenedor.style.opacity = '1';
            }
        }
    </script>
</body>
</html> 